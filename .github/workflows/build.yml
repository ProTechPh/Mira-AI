name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  version-patch-main:
    if: github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump patch version and push
        run: |
          git fetch --tags --force

          NEXT_VERSION=$(node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
          const [maj, min, pat] = String(pkg.version).split('.').map(Number);
          if ([maj, min, pat].some((n) => Number.isNaN(n))) {
            throw new Error(`Invalid semver in package.json: ${pkg.version}`);
          }

          let a = maj, b = min, c = pat + 1;
          const { execSync } = require('child_process');
          const tagExists = (v) => {
            try {
              execSync(`git rev-parse -q --verify refs/tags/v${v}`, { stdio: 'ignore' });
              return true;
            } catch {
              return false;
            }
          };

          while (tagExists(`${a}.${b}.${c}`)) c += 1;
          process.stdout.write(`${a}.${b}.${c}`);
          NODE
          )

          echo "Using version: v$NEXT_VERSION"
          npm version "$NEXT_VERSION" -m "Release v%s"
          git push
          git push --tags

  build-windows:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build:win -- --publish never
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe

  build-macos:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build:mac -- --publish never
      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/*.dmg

  build-linux:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build:linux -- --publish never
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.snap

  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: release-files
      
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: release-files
      
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: release-files

      - name: Resolve release notes from PR
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            async function findPrByCommit(commitSha) {
              if (!commitSha) return null;
              const { data } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: commitSha
              });
              return data && data.length > 0 ? data[0] : null;
            }

            // 1) Try PR directly associated with tag commit
            let pr = await findPrByCommit(sha);

            // 2) If not found, try parent commit (common when tag commit is version bump)
            if (!pr) {
              const { data: commit } = await github.rest.repos.getCommit({ owner, repo, ref: sha });
              const parentSha = commit.parents && commit.parents.length > 0 ? commit.parents[0].sha : null;
              pr = await findPrByCommit(parentSha);
            }

            let body = '';
            if (pr) {
              body = `${pr.title}\n\n${pr.body || ''}`.trim();
              core.info(`Using PR #${pr.number} for release notes`);
            } else {
              const { data: commit } = await github.rest.repos.getCommit({ owner, repo, ref: sha });
              body = (commit.commit && commit.commit.message) ? commit.commit.message : context.ref;
              core.info('No PR found for commit; using commit message as fallback');
            }

            core.setOutput('body', body);
      
      - name: Create Release on Mira-Release
        # This action creates a release in the external repository ProTechPh/Mira-Release
        # Requires a personal access token with `repo` scope stored in repository secrets as `RELEASE_REPO_TOKEN`.
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_REPO_TOKEN }}
          repository: ProTechPh/Mira-Release
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
          files: release-files/*
